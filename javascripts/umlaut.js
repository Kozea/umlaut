// Generated by CoffeeScript 1.6.3
var Actor, Association, Case, Database, Decision, Delay, Diagram, Document, Element, Ellipsis, Flow, FlowChart, IO, Inheritance, Link, Lozenge, Mouse, Process, Rect, SubProcess, Svg, Terminator, UseCase, commands, dist, edit, element_add, generate_url, history_pop, init_commands, link_add, list_diagrams, load, mouse_xy, save, _ref, _ref1, _ref10, _ref11, _ref12, _ref13, _ref14, _ref15, _ref16, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  _this = this,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

dist = function(o, t) {
  return Math.sqrt(Math.pow(t.x - o.x, 2) + Math.pow(t.y - o.y, 2));
};

Element = (function() {
  function Element(x, y, text, fixed) {
    this.x = x;
    this.y = y;
    this.text = text;
    this.fixed = fixed != null ? fixed : true;
    this.margin = {
      x: 10,
      y: 5
    };
  }

  Element.prototype.pos = function() {
    return {
      x: this.x,
      y: this.y
    };
  };

  Element.prototype.set_txt_bbox = function(bbox) {
    return this._txt_bbox = bbox;
  };

  Element.prototype.txt_width = function() {
    return this._txt_bbox.width;
  };

  Element.prototype.txt_height = function() {
    return this._txt_bbox.height;
  };

  Element.prototype.txt_x = function() {
    return 0;
  };

  Element.prototype.txt_y = function() {
    return -this.txt_height() / 2;
  };

  Element.prototype.width = function() {
    return this.txt_width() + 2 * this.margin.x;
  };

  Element.prototype.height = function() {
    return this.txt_height() + 2 * this.margin.y;
  };

  Element.prototype.direction = function(x, y) {
    var delta;
    delta = this.height() / this.width();
    if (this.x <= x && this.y <= y) {
      if (y > delta * (x - this.x) + this.y) {
        return 'S';
      } else {
        return 'E';
      }
    }
    if (this.x >= x && this.y <= y) {
      if (y > delta * (this.x - x) + this.y) {
        return 'S';
      } else {
        return 'O';
      }
    }
    if (this.x <= x && this.y >= y) {
      if (y > delta * (this.x - x) + this.y) {
        return 'E';
      } else {
        return 'N';
      }
    }
    if (this.x >= x && this.y >= y) {
      if (y > delta * (x - this.x) + this.y) {
        return 'O';
      } else {
        return 'N';
      }
    }
  };

  Element.prototype.anchor = function(direction) {
    switch (direction) {
      case 'N':
        return {
          x: this.x,
          y: this.y - this.height() / 2
        };
      case 'S':
        return {
          x: this.x,
          y: this.y + this.height() / 2
        };
      case 'E':
        return {
          x: this.x + this.width() / 2,
          y: this.y
        };
      case 'O':
        return {
          x: this.x - this.width() / 2,
          y: this.y
        };
    }
  };

  Element.prototype["in"] = function(rect) {
    var _ref, _ref1;
    return (rect.x < (_ref = this.x) && _ref < rect.x + rect.width) && (rect.y < (_ref1 = this.y) && _ref1 < rect.y + rect.height);
  };

  Element.prototype.objectify = function() {
    return {
      name: this.constructor.name,
      x: this.x,
      y: this.y,
      text: this.text,
      fixed: this.fixed
    };
  };

  return Element;

})();

Mouse = (function(_super) {
  __extends(Mouse, _super);

  function Mouse() {
    _ref = Mouse.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  Mouse.prototype.width = function() {
    return 1;
  };

  Mouse.prototype.height = function() {
    return 1;
  };

  Mouse.prototype.weight = 1;

  return Mouse;

})(Element);

Link = (function() {
  Link.marker = 'arrow';

  Link.prototype.text_margin = 10;

  function Link(source, target, text) {
    this.source = source;
    this.target = target;
    this.a1 = this.a2 = 0;
    this.text = {
      source: (text != null ? text.source : void 0) || '',
      target: (text != null ? text.target : void 0) || ''
    };
  }

  Link.prototype.objectify = function() {
    return {
      name: this.constructor.name,
      source: diagram.elements.indexOf(this.source),
      target: diagram.elements.indexOf(this.target),
      text: this.text
    };
  };

  Link.prototype.nearest = function(pos) {
    if (dist(pos, this.source) < dist(pos, this.target)) {
      return this.source;
    } else {
      return this.target;
    }
  };

  Link.prototype.path = function() {
    var c1, c2, horz, m, mid, path, vert, _ref1, _ref10, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9;
    c1 = this.source.pos();
    c2 = this.target.pos();
    if (void 0 === c1.x || void 0 === c1.y || void 0 === c2.x || void 0 === c2.y) {
      return 'M 0 0';
    }
    this.d1 = this.source.direction(c2.x, c2.y);
    this.d2 = this.target.direction(c1.x, c1.y);
    this.a1 = this.source.anchor(this.d1);
    this.a2 = this.target.anchor(this.d2);
    path = "M " + this.a1.x + " " + this.a1.y;
    vert = ['N', 'S'];
    horz = ['E', 'O'];
    if (diagram.linkstyle === 'curve') {
      path = "" + path + " C";
      m = {
        x: .5 * (this.a1.x + this.a2.x),
        y: .5 * (this.a1.y + this.a2.y)
      };
      if (_ref1 = this.d1, __indexOf.call(vert, _ref1) >= 0) {
        path = "" + path + " " + this.a1.x + " " + m.y;
      } else {
        path = "" + path + " " + m.x + " " + this.a1.y;
      }
      if (_ref2 = this.d2, __indexOf.call(vert, _ref2) >= 0) {
        path = "" + path + " " + this.a2.x + " " + m.y;
      } else {
        path = "" + path + " " + m.x + " " + this.a2.y;
      }
    } else if (diagram.linkstyle === 'diagonal') {
      path = "" + path + " L";
    } else if (diagram.linkstyle === 'rectangular') {
      path = "" + path + " L";
      if ((_ref3 = this.d1, __indexOf.call(vert, _ref3) >= 0) && (_ref4 = this.d2, __indexOf.call(horz, _ref4) >= 0)) {
        path = "" + path + " " + this.a1.x + " " + this.a2.y + " L";
      } else if ((_ref5 = this.d1, __indexOf.call(horz, _ref5) >= 0) && (_ref6 = this.d2, __indexOf.call(vert, _ref6) >= 0)) {
        path = "" + path + " " + this.a2.x + " " + this.a1.y + " L";
      } else if ((_ref7 = this.d1, __indexOf.call(horz, _ref7) >= 0) && (_ref8 = this.d2, __indexOf.call(horz, _ref8) >= 0)) {
        mid = this.a1.x + .5 * (this.a2.x - this.a1.x);
        path = "" + path + " " + mid + " " + this.a1.y + " L " + mid + " " + this.a2.y + " L";
      } else if ((_ref9 = this.d1, __indexOf.call(vert, _ref9) >= 0) && (_ref10 = this.d2, __indexOf.call(vert, _ref10) >= 0)) {
        mid = this.a1.y + .5 * (this.a2.y - this.a1.y);
        path = "" + path + " " + this.a1.x + " " + mid + " L " + this.a2.x + " " + mid + " L";
      }
    }
    return "" + path + " " + this.a2.x + " " + this.a2.y;
  };

  return Link;

})();

Diagram = (function() {
  Diagram.diagrams = {};

  function Diagram() {
    this.title = 'Untitled ' + this.label;
    this.linkstyle = 'rectangular';
    this.zoom = {
      scale: 1,
      translate: [0, 0]
    };
    this.elements = [];
    this.links = [];
    this.snap = 25;
    this.freemode = false;
    this.types = {};
    this.selection = [];
    this.linking = [];
    this.mouse = new Mouse(0, 0, '');
    this.dragging = false;
    this.no_save = false;
  }

  Diagram.prototype.element = function(name) {
    var elt, _i, _len, _ref1;
    _ref1 = this.types.elements;
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      elt = _ref1[_i];
      if (elt.name === name) {
        return elt;
      }
    }
  };

  Diagram.prototype.link = function(name) {
    var lnk, _i, _len, _ref1;
    _ref1 = this.types.links;
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      lnk = _ref1[_i];
      if (lnk.name === name) {
        return lnk;
      }
    }
  };

  Diagram.prototype.objectify = function() {
    return {
      name: this.constructor.name,
      title: this.title,
      linkstyle: this.linkstyle,
      zoom: this.zoom,
      freemode: this.freemode,
      elements: this.elements.map(function(elt) {
        return elt.objectify();
      }),
      links: this.links.map(function(lnk) {
        return lnk.objectify();
      })
    };
  };

  Diagram.prototype.hash = function() {
    return btoa(JSON.stringify(this.objectify()));
  };

  Diagram.prototype.loads = function(obj) {
    var element, elt, link, lnk, _i, _j, _len, _len1, _ref1, _ref2, _results;
    if (obj.title) {
      this.title = obj.title;
    }
    if (obj.linkstyle) {
      this.linkstyle = obj.linkstyle;
    }
    if (obj.zoom) {
      this.zoom = obj.zoom;
    }
    if (obj.freemode) {
      this.freemode = obj.freemode;
    }
    _ref1 = obj.elements;
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      elt = _ref1[_i];
      element = diagram.element(elt.name);
      diagram.elements.push(new element(elt.x, elt.y, elt.text, elt.fixed));
    }
    _ref2 = obj.links;
    _results = [];
    for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
      lnk = _ref2[_j];
      link = diagram.link(lnk.name);
      _results.push(diagram.links.push(new link(diagram.elements[lnk.source], diagram.elements[lnk.target], lnk.text)));
    }
    return _results;
  };

  return Diagram;

})();

Rect = (function(_super) {
  __extends(Rect, _super);

  function Rect() {
    _ref1 = Rect.__super__.constructor.apply(this, arguments);
    return _ref1;
  }

  Rect.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2) + " " + (-h2) + "         L " + w2 + " " + (-h2) + "         L " + w2 + " " + h2 + "         L " + (-w2) + " " + h2 + "         z";
  };

  return Rect;

})(Element);

Ellipsis = (function(_super) {
  __extends(Ellipsis, _super);

  function Ellipsis() {
    _ref2 = Ellipsis.__super__.constructor.apply(this, arguments);
    return _ref2;
  }

  Ellipsis.prototype.width = function() {
    return 2 * Ellipsis.__super__.width.call(this) / Math.sqrt(2);
  };

  Ellipsis.prototype.height = function() {
    return 2 * Ellipsis.__super__.height.call(this) / Math.sqrt(2);
  };

  Ellipsis.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2) + " 0         A " + w2 + " " + h2 + " 0 1 1 " + w2 + " 0         A " + w2 + " " + h2 + " 0 1 1 " + (-w2) + " 0        ";
  };

  return Ellipsis;

})(Element);

Lozenge = (function(_super) {
  __extends(Lozenge, _super);

  function Lozenge() {
    _ref3 = Lozenge.__super__.constructor.apply(this, arguments);
    return _ref3;
  }

  Lozenge.prototype.width = function() {
    var ow;
    ow = Lozenge.__super__.width.call(this);
    return ow + Math.sqrt(ow * this.txt_height() + 2 * this.margin.y);
  };

  Lozenge.prototype.height = function() {
    var oh;
    oh = Lozenge.__super__.height.call(this);
    return oh + Math.sqrt(oh * this.txt_width() + 2 * this.margin.x);
  };

  Lozenge.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2) + " 0         L 0 " + (-h2) + "         L " + w2 + " 0         L 0 " + h2 + "         z";
  };

  return Lozenge;

})(Element);

Process = (function(_super) {
  __extends(Process, _super);

  function Process() {
    _ref4 = Process.__super__.constructor.apply(this, arguments);
    return _ref4;
  }

  return Process;

})(Rect);

IO = (function(_super) {
  __extends(IO, _super);

  function IO() {
    _ref5 = IO.__super__.constructor.apply(this, arguments);
    return _ref5;
  }

  IO.prototype.shift = 5;

  IO.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2 - this.shift) + " " + (-h2) + "         L " + (w2 - this.shift) + " " + (-h2) + "         L " + (w2 + this.shift) + " " + h2 + "         L " + (-w2 + this.shift) + " " + h2 + "         z";
  };

  return IO;

})(Element);

Terminator = (function(_super) {
  __extends(Terminator, _super);

  function Terminator() {
    _ref6 = Terminator.__super__.constructor.apply(this, arguments);
    return _ref6;
  }

  Terminator.prototype.shift = 10;

  Terminator.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2 + this.shift) + " " + (-h2) + "         L " + (w2 - this.shift) + " " + (-h2) + "         Q " + w2 + " " + (-h2) + " " + w2 + " " + (-h2 + this.shift) + "         L " + w2 + " " + (h2 - this.shift) + "         Q " + w2 + " " + h2 + " " + (w2 - this.shift) + " " + h2 + "         L " + (-w2 + this.shift) + " " + h2 + "         Q " + (-w2) + " " + h2 + " " + (-w2) + " " + (h2 - this.shift) + "         L " + (-w2) + " " + (-h2 + this.shift) + "         Q " + (-w2) + " " + (-h2) + " " + (-w2 + this.shift) + " " + (-h2);
  };

  return Terminator;

})(Element);

Decision = (function(_super) {
  __extends(Decision, _super);

  function Decision() {
    _ref7 = Decision.__super__.constructor.apply(this, arguments);
    return _ref7;
  }

  return Decision;

})(Lozenge);

Delay = (function(_super) {
  __extends(Delay, _super);

  function Delay() {
    _ref8 = Delay.__super__.constructor.apply(this, arguments);
    return _ref8;
  }

  Delay.prototype.txt_x = function() {
    return Delay.__super__.txt_x.call(this) - this.height() / 4;
  };

  Delay.prototype.width = function() {
    return Delay.__super__.width.call(this) + this.height() / 2;
  };

  Delay.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2) + " " + (-h2) + "         L " + (w2 - h2) + " " + (-h2) + "         A " + h2 + " " + h2 + " 0 1 1 " + (w2 - h2) + " " + h2 + "         L " + (-w2) + " " + h2 + "         z";
  };

  return Delay;

})(Element);

SubProcess = (function(_super) {
  __extends(SubProcess, _super);

  function SubProcess() {
    _ref9 = SubProcess.__super__.constructor.apply(this, arguments);
    return _ref9;
  }

  SubProcess.prototype.shift = 10;

  SubProcess.prototype.width = function() {
    return SubProcess.__super__.width.call(this) + 2 * this.shift;
  };

  SubProcess.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "" + (SubProcess.__super__.path.call(this)) + "         M " + (-w2 + this.shift) + " " + (-h2) + "         L " + (-w2 + this.shift) + " " + h2 + "         M " + (w2 - this.shift) + " " + (-h2) + "         L " + (w2 - this.shift) + " " + h2 + "        ";
  };

  return SubProcess;

})(Process);

Document = (function(_super) {
  __extends(Document, _super);

  function Document() {
    _ref10 = Document.__super__.constructor.apply(this, arguments);
    return _ref10;
  }

  Document.prototype.height = function() {
    return Document.__super__.height.call(this) * 1.25;
  };

  Document.prototype.txt_y = function() {
    return Document.__super__.txt_y.call(this) - this.height() / 16;
  };

  Document.prototype.path = function() {
    var h2, w2;
    w2 = this.width() / 2;
    h2 = this.height() / 2;
    return "M " + (-w2) + " " + (-h2) + "         L " + w2 + " " + (-h2) + "         L " + w2 + " " + h2 + "         Q " + (w2 / 2) + " " + (h2 / 2) + " 0 " + h2 + "         T " + (-w2) + " " + h2 + "         z";
  };

  return Document;

})(Element);

Database = (function(_super) {
  __extends(Database, _super);

  function Database() {
    _ref11 = Database.__super__.constructor.apply(this, arguments);
    return _ref11;
  }

  Database.prototype.height = function() {
    return Database.__super__.height.call(this) + 2.5 * Math.min(this.width() / 2, Database.__super__.height.call(this) / 2);
  };

  Database.prototype.txt_y = function() {
    return Database.__super__.txt_y.call(this) + Math.min(this.width() / 2, (this.txt_height() + 2 * this.margin.y) / 2) / 2;
  };

  Database.prototype.path = function() {
    var h2, r, w2;
    w2 = this.width() / 2;
    h2 = (this.txt_height() + 2 * this.margin.y) / 2;
    r = Math.min(w2, h2);
    h2 += r / 2;
    return "M " + (-w2) + " " + (-h2) + "         A " + w2 + " " + r + " 0 1 1 " + w2 + " " + (-h2) + "         A " + w2 + " " + r + " 0 1 1 " + (-w2) + " " + (-h2) + "         M " + w2 + " " + (-h2) + "         L " + w2 + " " + h2 + "         A " + w2 + " " + r + " 0 1 1 " + (-w2) + " " + h2 + "         L " + (-w2) + " " + (-h2);
  };

  return Database;

})(Element);

Flow = (function(_super) {
  __extends(Flow, _super);

  function Flow() {
    _ref12 = Flow.__super__.constructor.apply(this, arguments);
    return _ref12;
  }

  return Flow;

})(Link);

FlowChart = (function(_super) {
  __extends(FlowChart, _super);

  FlowChart.prototype.label = 'Flow Chart';

  function FlowChart() {
    FlowChart.__super__.constructor.call(this);
    this.types = {
      elements: [Process, IO, Terminator, Decision, Delay, SubProcess, Document, Database],
      links: [Flow]
    };
  }

  return FlowChart;

})(Diagram);

Diagram.diagrams['FlowChart'] = FlowChart;

Case = (function(_super) {
  __extends(Case, _super);

  function Case() {
    _ref13 = Case.__super__.constructor.apply(this, arguments);
    return _ref13;
  }

  return Case;

})(Ellipsis);

Actor = (function(_super) {
  __extends(Actor, _super);

  function Actor() {
    _ref14 = Actor.__super__.constructor.apply(this, arguments);
    return _ref14;
  }

  Actor.prototype.stick = 10;

  Actor.prototype.height = function() {
    return Actor.__super__.height.call(this) + 4 * this.stick;
  };

  Actor.prototype.txt_y = function() {
    return this.height() / 2 - this.txt_height();
  };

  Actor.prototype.path = function() {
    var bottom;
    bottom = this.height() / 2 - this.txt_height() - this.margin.y;
    return "M " + (-this.stick) + " " + bottom + "         L 0 " + (bottom - this.stick) + "         M " + this.stick + " " + bottom + "         L 0 " + (bottom - this.stick) + "         M 0 " + (bottom - this.stick) + "         L 0 " + (bottom - 2 * this.stick) + "         M " + (-this.stick) + " " + (bottom - 2 * this.stick) + "         L " + this.stick + " " + (bottom - 2 * this.stick) + "         M 0 " + (bottom - 2 * this.stick) + "         L 0 " + (bottom - 3 * this.stick) + "         A " + (.5 * this.stick) + " " + (.5 * this.stick) + " 0 1 1 0 " + (bottom - 4 * this.stick) + "         A " + (.5 * this.stick) + " " + (.5 * this.stick) + " 0 1 1 0 " + (bottom - 3 * this.stick) + "         ";
  };

  return Actor;

})(Element);

Association = (function(_super) {
  __extends(Association, _super);

  function Association() {
    _ref15 = Association.__super__.constructor.apply(this, arguments);
    return _ref15;
  }

  return Association;

})(Link);

Inheritance = (function(_super) {
  __extends(Inheritance, _super);

  function Inheritance() {
    _ref16 = Inheritance.__super__.constructor.apply(this, arguments);
    return _ref16;
  }

  Inheritance.marker = 'lozenge';

  return Inheritance;

})(Link);

UseCase = (function(_super) {
  __extends(UseCase, _super);

  UseCase.prototype.label = 'UML Use case';

  function UseCase() {
    UseCase.__super__.constructor.call(this);
    this.linkstyle = 'diagonal';
    this.types = {
      elements: [Actor, Case],
      links: [Association, Inheritance]
    };
  }

  return UseCase;

})(Diagram);

Diagram.diagrams['UseCase'] = UseCase;

element_add = function(type) {
  var mouse_evt, new_elt, node, nth, x, y;
  x = diagram.mouse.x;
  y = diagram.mouse.y;
  nth = diagram.elements.filter(function(elt) {
    return elt instanceof type;
  }).length + 1;
  new_elt = new type(x, y, "" + type.name + " #" + nth, !diagram.freemode);
  diagram.elements.push(new_elt);
  if (d3.event) {
    svg.svg.select('.selected').classed('selected', false);
    diagram.selection = [new_elt];
  }
  svg.sync();
  if (d3.event) {
    node = null;
    d3.selectAll('g.element').each(function(elt) {
      if (elt === new_elt) {
        node = this;
        return d3.select(node).classed('selected', true);
      }
    });
    mouse_evt = document.createEvent('MouseEvent');
    mouse_evt.initMouseEvent(d3.event.type, d3.event.canBubble, d3.event.cancelable, d3.event.view, d3.event.detail, d3.event.screenX, d3.event.screenY, d3.event.clientX, d3.event.clientY, d3.event.ctrlKey, d3.event.altKey, d3.event.shiftKey, d3.event.metaKey, d3.event.button, d3.event.relatedTarget);
    return node.dispatchEvent(mouse_evt);
  }
};

link_add = function(type) {
  var elt, _i, _len, _ref17;
  diagram.linking = [];
  _ref17 = diagram.selection;
  for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
    elt = _ref17[_i];
    diagram.linking.push(new type(elt, diagram.mouse));
  }
  return svg.sync();
};

commands = {
  undo: {
    fun: function(e) {
      history.go(-1);
      return e != null ? e.preventDefault() : void 0;
    },
    label: 'Undo',
    glyph: 'chevron-left',
    hotkey: 'ctrl+z'
  },
  redo: {
    fun: function(e) {
      history.go(1);
      return e != null ? e.preventDefault() : void 0;
    },
    label: 'Redo',
    glyph: 'chevron-right',
    hotkey: 'ctrl+y'
  },
  save: {
    fun: function(e) {
      save();
      return e != null ? e.preventDefault() : void 0;
    },
    label: 'Save locally',
    glyph: 'save',
    hotkey: 'ctrl+s'
  },
  edit: {
    fun: function() {
      edit((function() {
        if (diagram.selection.length === 1) {
          return diagram.selection[0].text;
        } else {
          return '';
        }
      }), (function(txt) {
        var elt, _i, _len, _ref17, _results;
        _ref17 = diagram.selection;
        _results = [];
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          elt = _ref17[_i];
          _results.push(elt.text = txt);
        }
        return _results;
      }));
      return svg.sync();
    },
    label: 'Edit elements text',
    glyph: 'edit',
    hotkey: 'e'
  },
  remove: {
    fun: function() {
      var elt, lnk, _i, _j, _len, _len1, _ref17, _ref18;
      _ref17 = diagram.selection;
      for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
        elt = _ref17[_i];
        diagram.elements.splice(diagram.elements.indexOf(elt), 1);
        _ref18 = diagram.links.slice();
        for (_j = 0, _len1 = _ref18.length; _j < _len1; _j++) {
          lnk = _ref18[_j];
          if (elt === lnk.source || elt === lnk.target) {
            diagram.links.splice(diagram.links.indexOf(lnk), 1);
          }
        }
      }
      diagram.selection = [];
      svg.svg.selectAll('g.element').classed('selected', false);
      return svg.sync();
    },
    label: 'Remove elements',
    glyph: 'remove-sign',
    hotkey: 'del'
  },
  select_all: {
    fun: function(e) {
      diagram.selection = diagram.elements.slice();
      svg.svg.selectAll('g.element').classed('selected', true);
      return e != null ? e.preventDefault() : void 0;
    },
    label: 'Select all elements',
    glyph: 'fullscreen',
    hotkey: 'ctrl+a'
  },
  reorganize: {
    fun: function() {
      var elt, sel, _i, _len;
      sel = diagram.selection.length > 0 ? diagram.selection : diagram.elements;
      for (_i = 0, _len = sel.length; _i < _len; _i++) {
        elt = sel[_i];
        elt.fixed = false;
      }
      return svg.sync();
    },
    label: 'Reorganize',
    glyph: 'th',
    hotkey: 'r'
  },
  freemode: {
    fun: function() {
      var elt, _i, _len, _ref17;
      _ref17 = diagram.elements;
      for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
        elt = _ref17[_i];
        elt.fixed = diagram.freemode;
      }
      if (diagram.freemode) {
        svg.force.stop();
      } else {
        svg.sync();
      }
      return diagram.freemode = !diagram.freemode;
    },
    label: 'Toggle free mode',
    glyph: 'send',
    hotkey: 'tab'
  },
  linkstyle: {
    fun: function() {
      diagram.linkstyle = (function() {
        switch (diagram.linkstyle) {
          case 'curve':
            return 'diagonal';
          case 'diagonal':
            return 'rectangular';
          case 'rectangular':
            return 'curve';
        }
      })();
      return svg.tick();
    },
    label: 'Change link style',
    glyph: 'retweet',
    hotkey: 'space'
  },
  defaultscale: {
    fun: function() {
      svg.zoom.scale(1);
      svg.zoom.translate([0, 0]);
      return svg.zoom.event(svg.underlay_g);
    },
    label: 'Reset view',
    glyph: 'screenshot',
    hotkey: 'ctrl+backspace'
  },
  snaptogrid: {
    fun: function() {
      var elt, _i, _len, _ref17;
      _ref17 = diagram.elements;
      for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
        elt = _ref17[_i];
        elt.x = elt.px = diagram.snap * Math.floor(elt.x / diagram.snap);
        elt.y = elt.py = diagram.snap * Math.floor(elt.y / diagram.snap);
      }
      return svg.tick();
    },
    label: 'Snap to grid',
    glyph: 'magnet',
    hotkey: 'ctrl+space'
  }
};

$(function() {
  var button, command, name, _results;
  _results = [];
  for (name in commands) {
    command = commands[name];
    button = d3.select('aside .btns').append('button').attr('title', "" + command.label + " [" + command.hotkey + "]").attr('class', 'btn btn-default btn-sm').on('click', command.fun);
    if (command.glyph) {
      button.append('span').attr('class', "glyphicon glyphicon-" + command.glyph);
    }
    _results.push(Mousetrap.bind(command.hotkey, command.fun));
  }
  return _results;
});

init_commands = function() {
  var e, e1, e2, fun, g, hotkey, i, icon, key, l, margin, path, svgicon, taken_hotkeys, txt, _i, _j, _len, _len1, _ref17, _ref18, _results;
  taken_hotkeys = [];
  $('aside .icons .specific').each(function() {
    return Mousetrap.unbind($(this).attr('data-hotkey'));
  });
  $('aside .icons svg').remove();
  $('aside .sep').attr('id', diagram.constructor.name).addClass('specific').text(diagram.label);
  _ref17 = diagram.types.elements;
  for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
    e = _ref17[_i];
    i = 1;
    key = e.name[0].toLowerCase();
    while (i < e.length && __indexOf.call(taken_hotkeys, key) >= 0) {
      key = e[i++].toLowerCase();
    }
    taken_hotkeys.push(key);
    fun = (function(elt) {
      return function() {
        return element_add(elt);
      };
    })(e);
    hotkey = "a " + key;
    icon = new e(0, 0, e.name);
    svgicon = d3.select('aside .icons').append('svg').attr('class', 'icon specific draggable btn btn-default').attr('title', "" + e.name + " [" + hotkey + "]").attr('data-hotkey', hotkey).on('mousedown', fun);
    g = svgicon.append('g').attr('class', 'element');
    path = g.append('path').attr('class', 'shape');
    txt = g.append('text').text(e.name);
    icon.set_txt_bbox(txt.node().getBBox());
    path.attr('d', icon.path());
    txt.attr('x', icon.txt_x()).attr('y', icon.txt_y());
    margin = 3;
    svgicon.attr('viewBox', "                " + (-icon.width() / 2 - margin) + "                " + (-icon.height() / 2 - margin) + "                " + (icon.width() + 2 * margin) + "                " + (icon.height() + 2 * margin)).attr('width', icon.width()).attr('height', icon.height()).attr('preserveAspectRatio', 'xMidYMid Meet');
    Mousetrap.bind(hotkey, fun);
  }
  taken_hotkeys = [];
  _ref18 = diagram.types.links;
  _results = [];
  for (_j = 0, _len1 = _ref18.length; _j < _len1; _j++) {
    l = _ref18[_j];
    i = 1;
    key = l.name[0].toLowerCase();
    while (i < l.length && __indexOf.call(taken_hotkeys, key) >= 0) {
      key = l[i++].toLowerCase();
    }
    taken_hotkeys.push(key);
    fun = (function(lnk) {
      return function() {
        return link_add(lnk);
      };
    })(l);
    hotkey = "l " + key;
    icon = new l(e1 = new Element(0, 0), e2 = new Element(100, 0));
    e1.set_txt_bbox({
      width: 10,
      height: 10
    });
    e2.set_txt_bbox({
      width: 10,
      height: 10
    });
    svgicon = d3.select('aside .icons').append('svg').attr('class', 'icon specific draggable btn btn-default').attr('title', "" + l.name + " [" + hotkey + "]").attr('data-hotkey', hotkey).on('mousedown', fun);
    g = svgicon.append('g').attr('class', 'link');
    g.append('svg:defs').append('svg:marker').attr('id', 'arrow').attr('viewBox', '0 0 10 10').attr('refX', 10).attr('refY', 5).attr('markerUnits', 'userSpaceOnUse').attr('markerWidth', 10).attr('markerHeight', 10).attr('orient', 'auto').append('svg:path').attr('d', 'M 0 0 L 10 5 L 0 10');
    path = svgicon.append('path').attr("class", "link").attr("marker-end", "url(#" + icon.constructor.marker + ")").attr('d', icon.path());
    svgicon.attr('height', 10).attr('viewBox', "0 -5 100 10").attr('preserveAspectRatio', 'none');
    _results.push(Mousetrap.bind(hotkey, fun));
  }
  return _results;
};

edit = function(getter, setter) {
  var overlay, textarea, textarea_node;
  overlay = d3.select('#overlay').classed('visible', true);
  textarea = overlay.select('textarea');
  textarea_node = textarea.node();
  textarea.on('input', function() {
    setter(this.value);
    return svg.sync();
  }).on('keydown', function() {
    if (d3.event.keyCode === 27) {
      textarea.on('input', null);
      textarea.on('keydown', null);
      textarea_node.value = '';
      return overlay.classed('visible', false);
    }
  });
  textarea_node.value = getter();
  textarea_node.select();
  textarea_node.focus();
  return overlay.on('click', function() {
    if (d3.event.target === this) {
      textarea.on('input', null);
      textarea.on('keydown', null);
      textarea_node.value = '';
      return overlay.classed('visible', false);
    }
  });
};

mouse_xy = function(e) {
  var m;
  m = d3.mouse(e);
  return {
    x: (m[0] - diagram.zoom.translate[0]) / diagram.zoom.scale,
    y: (m[1] - diagram.zoom.translate[1]) / diagram.zoom.scale
  };
};

Svg = (function() {
  function Svg() {
    this.tick = __bind(this.tick, this);
    var _this = this;
    this.aside = d3.select('aside');
    this.article = d3.select("article");
    this.width = this.article.node().clientWidth;
    this.height = this.article.node().clientHeight || 500;
    this.title = d3.select('#editor h2').on('dblclick', function() {
      return edit((function() {
        return diagram.title;
      }), (function(txt) {
        return diagram.title = txt;
      }));
    });
    this.svg = this.article.append("svg").attr('id', "diagram").attr("width", this.width).attr("height", this.height);
    this.underlay_g = this.svg.append('g');
    this.underlay = this.underlay_g.append('rect').attr('class', 'underlay').attr('width', this.width).attr('height', this.height).attr('fill', 'url(#grid)');
    d3.select(window).on('resize', function() {
      return _this.resize();
    });
    this.defs = this.svg.append('svg:defs');
    this.defs.append('svg:marker').attr('id', 'arrow').attr('viewBox', '0 0 10 10').attr('refX', 10).attr('refY', 5).attr('markerUnits', 'userSpaceOnUse').attr('markerWidth', 10).attr('markerHeight', 10).attr('orient', 'auto').append('svg:path').attr('d', 'M 0 0 L 10 5 L 0 10');
    this.defs.append('svg:marker').attr('id', 'lozenge').attr('viewBox', '0 0 10 10').attr('refX', 10).attr('refY', 5).attr('markerUnits', 'userSpaceOnUse').attr('markerWidth', 10).attr('markerHeight', 10).attr('orient', 'auto').append('svg:path').attr('d', 'M 0 5 L 5 0 L 10 5 L 5 10 z');
    this.pattern = this.defs.append('svg:pattern').attr('id', 'grid').attr('viewBox', '0 0 10 10').attr('x', 0).attr('y', 0).attr('width', diagram.snap).attr('height', diagram.snap).attr('patternUnits', 'userSpaceOnUse');
    this.pattern.append('svg:path').attr('d', 'M 10 0 L 0 0 L 0 10');
    this.root = this.underlay_g.append('g').attr('class', 'root');
    this.force = d3.layout.force().gravity(.2).linkDistance(300).charge(-5000).size([this.width, this.height]);
    this.drag = this.force.drag().on("drag.force", function(elt) {
      var delta, _i, _len, _ref17, _ref18;
      if (!diagram.dragging || d3.event.sourceEvent.ctrlKey) {
        return;
      }
      if (_ref17 = !elt, __indexOf.call(diagram.selection, _ref17) >= 0) {
        diagram.selection.push(elt);
      }
      if (d3.event.sourceEvent.shiftKey) {
        delta = {
          x: elt.px - d3.event.x,
          y: elt.py - d3.event.y
        };
      } else {
        delta = {
          x: elt.px - diagram.snap * Math.floor(d3.event.x / diagram.snap),
          y: elt.py - diagram.snap * Math.floor(d3.event.y / diagram.snap)
        };
      }
      _ref18 = diagram.selection;
      for (_i = 0, _len = _ref18.length; _i < _len; _i++) {
        elt = _ref18[_i];
        elt.px -= delta.x;
        elt.py -= delta.y;
      }
      return _this.force.resume();
    }).on('dragstart', function() {
      if (d3.event.sourceEvent.which === 3 || d3.event.sourceEvent.ctrlKey) {
        return;
      }
      return diagram.dragging = true;
    }).on('dragend', function(elt) {
      var lnk, _i, _len, _ref17;
      if (!diagram.dragging) {
        return;
      }
      if (!$(d3.event.sourceEvent.target).closest('#diagram').size()) {
        diagram.elements.splice(diagram.elements.indexOf(elt), 1);
        if (__indexOf.call(diagram.selection, elt) >= 0) {
          diagram.selection.splice(diagram.selection.indexOf(elt), 1);
        }
        _ref17 = diagram.links.slice();
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          lnk = _ref17[_i];
          if (elt === lnk.source || elt === lnk.target) {
            diagram.links.splice(diagram.links.indexOf(lnk), 1);
          }
        }
        svg.sync();
      }
      diagram.dragging = false;
      if (!diagram.freemode) {
        return elt.fixed = true;
      }
    });
    this.element = null;
    this.link = null;
    this.svg.on("mousedown", function(event) {
      var elt, mouse, _i, _len, _ref17;
      if (diagram.dragging || d3.event.ctrlKey || d3.event.which === 2) {
        return;
      }
      if (d3.event.which === 3) {
        diagram.linking = [];
        _ref17 = diagram.selection;
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          elt = _ref17[_i];
          diagram.linking.push(new diagram.types.links[0](elt, diagram.mouse));
        }
        _this.sync();
      } else {
        if (!d3.event.shiftKey) {
          _this.svg.selectAll('.selected').classed('selected', false);
          diagram.selection = [];
        }
        mouse = mouse_xy(_this.svg.node());
        _this.svg.select('g.overlay').append("rect").attr({
          "class": "selection",
          x: mouse.x,
          y: mouse.y,
          width: 0,
          height: 0
        });
      }
      return d3.event.preventDefault();
    }).on('contextmenu', function() {
      if (!d3.event.shiftKey) {
        return d3.event.preventDefault();
      }
    });
    d3.select(window).on("mousemove", function() {
      var mouse, move, rect, sel;
      if (d3.event.ctrlKey) {
        return;
      }
      mouse = mouse_xy(_this.svg.node());
      diagram.mouse.x = mouse.x;
      diagram.mouse.y = mouse.y;
      if (diagram.linking.length) {
        _this.tick();
        return;
      }
      sel = _this.svg.select("rect.selection");
      if (!sel.empty()) {
        rect = {
          x: +sel.attr("x"),
          y: +sel.attr("y"),
          width: +sel.attr("width"),
          height: +sel.attr("height")
        };
        move = {
          x: mouse.x - rect.x,
          y: mouse.y - rect.y
        };
        if (move.x < 1 || (move.x * 2 < rect.width)) {
          rect.x = mouse.x;
          rect.width -= move.x;
        } else {
          rect.width = move.x;
        }
        if (move.y < 1 || (move.y * 2 < rect.height)) {
          rect.y = mouse.y;
          rect.height -= move.y;
        } else {
          rect.height = move.y;
        }
        rect.width = Math.max(0, rect.width);
        rect.height = Math.max(0, rect.height);
        sel.attr(rect);
        _this.svg.selectAll('g.element').each(function(elt) {
          var g, selected;
          g = d3.select(this);
          selected = g.classed('selected');
          if (elt["in"](rect) && !selected) {
            diagram.selection.push(elt);
            return g.classed('selected', true);
          } else if (!elt["in"](rect) && selected && !d3.event.shiftKey) {
            diagram.selection.splice(diagram.selection.indexOf(elt), 1);
            return g.classed('selected', false);
          }
        });
        return d3.event.preventDefault();
      }
    }).on("mouseup", function() {
      if (d3.event.ctrlKey) {
        return;
      }
      if (diagram.linking.length) {
        diagram.linking = [];
        _this.sync();
      }
      _this.svg.selectAll("rect.selection").remove();
      return d3.event.preventDefault();
    }).on("keydown", function() {
      if (d3.event.ctrlKey) {
        return _this.underlay.classed('move', true);
      }
    }).on("keyup", function() {
      return _this.underlay.classed('move', false);
    });
    this.root.append('g').attr('class', 'links');
    this.root.append('g').attr('class', 'elements');
    this.root.append('g').attr('class', 'overlay');
    this.zoom = d3.behavior.zoom().scale(diagram.zoom.scale).translate(diagram.zoom.translate).scaleExtent([.15, 5]).on("zoom", function() {
      var _ref17;
      if (!d3.event.sourceEvent || ((_ref17 = d3.event.sourceEvent.type) === 'wheel' || _ref17 === 'click') || d3.event.sourceEvent.ctrlKey || d3.event.sourceEvent.which === 2) {
        diagram.zoom.translate = d3.event.translate;
        diagram.zoom.scale = d3.event.scale;
        _this.root.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        return _this.pattern.attr("patternTransform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
      } else {
        _this.zoom.scale(diagram.zoom.scale);
        return _this.zoom.translate(diagram.zoom.translate);
      }
    });
    this.underlay_g.call(this.zoom);
    this.force.on('tick', this.tick).on('end', function() {
      var elt, _i, _len, _ref17;
      if (!diagram.freemode) {
        _ref17 = diagram.elements;
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          elt = _ref17[_i];
          elt.fixed = true;
        }
      }
      _this.tick();
      return generate_url();
    });
  }

  Svg.prototype.sync = function() {
    var element_g, link_g,
      _this = this;
    this.zoom.scale(diagram.zoom.scale);
    this.zoom.translate(diagram.zoom.translate);
    this.zoom.event(this.underlay_g);
    this.title.text(diagram.title);
    this.force.nodes(diagram.elements).links(diagram.links);
    this.link = this.svg.select('g.links').selectAll('g.link').data(diagram.links.concat(diagram.linking));
    link_g = this.link.enter().append('g').attr("class", "link");
    link_g.append("path").attr("marker-end", function(lnk) {
      return "url(#" + lnk.constructor.marker + ")";
    });
    link_g.append("text").attr('class', "start");
    link_g.append("text").attr('class', "end");
    link_g.on('dblclick', function(lnk) {
      var nearest;
      if (d3.event.ctrlKey) {
        return;
      }
      nearest = lnk.nearest(diagram.mouse);
      if (nearest === lnk.source) {
        return edit((function() {
          return lnk.text.source;
        }), (function(txt) {
          return lnk.text.source = txt;
        }));
      } else {
        return edit((function() {
          return lnk.text.target;
        }), (function(txt) {
          return lnk.text.target = txt;
        }));
      }
    });
    this.element = this.svg.select('g.elements').selectAll('g.element').data(diagram.elements);
    element_g = this.element.enter().append('g').attr('class', 'element').call(this.drag).on("mousedown", function(elt) {
      var selected;
      if (d3.event.ctrlKey) {
        return;
      }
      selected = d3.select(this).classed('selected');
      if ((selected && !diagram.dragging) || (!selected) && !d3.event.shiftKey) {
        svg.svg.selectAll('.selected').classed('selected', false);
        diagram.selection = [elt];
        d3.select(this).classed('selected', true);
      }
      if (d3.event.shiftKey && !selected) {
        d3.select(this).classed('selected', true);
        return diagram.selection.push(elt);
      }
    }).on("mousemove", function(elt) {
      var lnk, _i, _len, _ref17, _results;
      if (d3.event.ctrlKey) {
        return;
      }
      _ref17 = diagram.linking;
      _results = [];
      for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
        lnk = _ref17[_i];
        _results.push(lnk.target = elt);
      }
      return _results;
    }).on("mouseout", function(elt) {
      var lnk, _i, _len, _ref17, _results;
      if (d3.event.ctrlKey) {
        return;
      }
      _ref17 = diagram.linking;
      _results = [];
      for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
        lnk = _ref17[_i];
        _results.push(lnk.target = diagram.mouse);
      }
      return _results;
    }).on("mouseup", function(elt) {
      var lnk, _i, _len, _ref17;
      if (d3.event.ctrlKey) {
        return;
      }
      if (diagram.linking.length) {
        _ref17 = diagram.linking;
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          lnk = _ref17[_i];
          if (lnk.source !== elt) {
            diagram.links.push(new lnk.constructor(lnk.source, elt));
          }
        }
        diagram.linking = [];
        _this.sync();
        return d3.event.preventDefault();
      }
    }).on('dblclick', function(elt) {
      if (d3.event.ctrlKey) {
        return;
      }
      return edit((function() {
        return elt.text;
      }), (function(txt) {
        return elt.text = txt;
      }));
    });
    element_g.append('path').attr('class', 'shape');
    element_g.append('text');
    this.element.select('text').each(function(elt) {
      var i, line, tspan, txt, _i, _len, _ref17, _results;
      txt = d3.select(this);
      if (elt.text === txt.text) {
        return;
      }
      txt.selectAll('tspan').remove();
      _ref17 = elt.text.split('\n');
      _results = [];
      for (i = _i = 0, _len = _ref17.length; _i < _len; i = ++_i) {
        line = _ref17[i];
        tspan = txt.append('tspan').text(line).attr('x', 0);
        if (i !== 0) {
          _results.push(tspan.attr('dy', '1.2em'));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }).each(function(elt) {
      return elt.set_txt_bbox(this.getBBox());
    }).attr('x', function(elt) {
      return elt.txt_x();
    }).attr('y', function(elt) {
      return elt.txt_y();
    }).selectAll('tspan').attr('x', function(elt) {
      return elt.txt_x();
    });
    this.link.select('path').attr('d', function(lnk) {
      return lnk.path();
    });
    this.link.select('text.start').each(function(lnk) {
      var i, line, tspan, txt, _i, _len, _ref17, _results;
      txt = d3.select(this);
      if (lnk.text.source === txt.text) {
        return;
      }
      txt.selectAll('tspan').remove();
      _ref17 = lnk.text.source.split('\n');
      _results = [];
      for (i = _i = 0, _len = _ref17.length; _i < _len; i = ++_i) {
        line = _ref17[i];
        tspan = txt.append('tspan').text(line).attr('x', 0);
        if (i !== 0) {
          _results.push(tspan.attr('dy', '1.2em'));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    });
    this.link.select('text.end').each(function(lnk) {
      var i, line, tspan, txt, _i, _len, _ref17, _results;
      txt = d3.select(this);
      if (!lnk.text.target === txt.text) {
        return;
      }
      txt.selectAll('tspan').remove();
      _ref17 = lnk.text.target.split('\n');
      _results = [];
      for (i = _i = 0, _len = _ref17.length; _i < _len; i = ++_i) {
        line = _ref17[i];
        tspan = txt.append('tspan').text(line).attr('x', 0);
        if (i !== 0) {
          _results.push(tspan.attr('dy', '1.2em'));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    });
    this.element.select('path.shape').attr('d', function(elt) {
      return elt.path();
    });
    this.element.exit().remove();
    this.link.exit().remove();
    this.tick();
    return this.force.start();
  };

  Svg.prototype.tick = function() {
    var elt, need_force, _i, _len, _ref17;
    need_force = false;
    _ref17 = diagram.elements;
    for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
      elt = _ref17[_i];
      if (!elt.fixed) {
        need_force = true;
        break;
      }
    }
    need_force = need_force && (diagram.freemode || (this.force.alpha() || 1) > .03);
    if (!need_force && !diagram.dragging) {
      this.force.stop();
    }
    this.element.attr("transform", (function(elt) {
      return "translate(" + elt.x + "," + elt.y + ")";
    })).each(function(elt) {
      return d3.select(this).classed('moving', !elt.fixed);
    });
    this.link.select('path').attr("d", function(lnk) {
      return lnk.path();
    });
    this.link.select('text.start').attr('transform', function(lnk) {
      return "translate(" + lnk.a1.x + ", " + lnk.a1.y + ")";
    }).attr('dx', function(lnk) {
      var _ref18;
      if ((_ref18 = lnk.d1) === 'N' || _ref18 === 'E') {
        return lnk.text_margin + this.getBBox().width / 2;
      } else {
        return -(lnk.text_margin + this.getBBox().width / 2);
      }
    }).attr('dy', function(lnk) {
      var _ref18;
      if ((_ref18 = lnk.d1) === 'N' || _ref18 === 'E') {
        return -(this.getBBox().height + lnk.text_margin);
      } else {
        return lnk.text_margin;
      }
    });
    return this.link.select('text.end').attr('transform', function(lnk) {
      return "translate(" + lnk.a2.x + ", " + lnk.a2.y + ")";
    }).attr('dx', function(lnk) {
      var _ref18;
      if ((_ref18 = lnk.d2) === 'N' || _ref18 === 'E') {
        return lnk.text_margin + this.getBBox().width / 2;
      } else {
        return -(lnk.text_margin + this.getBBox().width / 2);
      }
    }).attr('dy', function(lnk) {
      var _ref18;
      if ((_ref18 = lnk.d2) === 'N' || _ref18 === 'E') {
        return -(this.getBBox().height + lnk.text_margin);
      } else {
        return lnk.text_margin;
      }
    });
  };

  Svg.prototype.resize = function() {
    this.width = this.article.node().clientWidth;
    this.height = this.article.node().clientHeight || 500;
    this.svg.attr("width", this.width).attr("height", this.height);
    return this.underlay.attr("width", this.width).attr("height", this.height);
  };

  return Svg;

})();

load = function(data) {
  var Type;
  Type = Diagram.diagrams[data.name];
  window.diagram = new Type();
  return diagram.loads(data);
};

save = function() {
  return localStorage.setItem("" + diagram.constructor.name + "|" + diagram.title, diagram.hash());
};

generate_url = function() {
  var hash;
  if (diagram.no_save) {
    diagram.no_save = false;
    return;
  }
  hash = '#' + diagram.hash();
  if (location.hash !== hash) {
    return history.pushState(null, null, hash);
  }
};

history_pop = function() {
  var $diagrams, $editor;
  $diagrams = $('#diagrams');
  $editor = $('#editor');
  if (!location.hash) {
    $diagrams.removeClass('hidden');
    $editor.addClass('hidden');
    list_diagrams();
    return;
  }
  $editor.removeClass('hidden');
  $diagrams.addClass('hidden');
  load(JSON.parse(atob(location.hash.slice(1))));
  if (typeof svg === "undefined" || svg === null) {
    window.svg = new Svg();
  }
  if (diagram.constructor.name !== $('aside .sep').attr('id')) {
    init_commands();
    svg.resize();
  }
  diagram.no_save = true;
  return svg.sync();
};

list_diagrams = function() {
  var $tbody, $tr, $ul, b64_diagram, diagram, key, name, title, type, _ref17, _ref18, _results;
  $tbody = $('#diagrams tbody');
  $tbody.find('.local').remove();
  for (key in localStorage) {
    b64_diagram = localStorage[key];
    _ref17 = key.split('|'), type = _ref17[0], title = _ref17[1];
    if (title == null) {
      continue;
    }
    $tbody.append($tr = $('<tr>'));
    $tr.addClass('local').append($('<td>').text(title), $('<td>').text(Diagram.diagrams[type].label), $('<td>').append($('<a>').attr('href', "#" + b64_diagram).text('⬈')));
  }
  $ul = $('#diagrams ul');
  $ul.children().remove();
  _ref18 = Diagram.diagrams;
  _results = [];
  for (name in _ref18) {
    type = _ref18[name];
    diagram = new type();
    b64_diagram = diagram.hash();
    _results.push($ul.append($('<li>').append($('<a>').attr('href', "#" + b64_diagram).text("New " + diagram.label))));
  }
  return _results;
};

$(function() {
  list_diagrams();
  _this.addEventListener("popstate", history_pop);
  if (location.hash && _this.mozInnerScreenX !== null) {
    return history_pop();
  }
});
